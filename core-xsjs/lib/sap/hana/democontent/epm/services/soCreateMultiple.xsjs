/* Create Sales Order with multiple line items*/
var body = $.request.body.asString();

var overallsoData = JSON.parse(body);

var responseBody = '';
var so_items;
var gross_amt = 0;
var prod_price = 0;
var lv_productid;
var lv_price;
var lv_quantity;
var lv_netamount;
var lv_taxamount;
var lv_grossamount;
var item_id = 10;
var lv_so_netamount = 0;
var lv_so_grossamount = 0;
var lv_so_taxamount = 0;
var i = 0;
var lv_bp_id;
var lv_company;
var lv_table;
var lv_tax = 0;
var result;
var rs, query, pc;
var taxCalculator;
var finalItemId;
responseBody += 'BP_ID:' + encodeURI(overallsoData.PARTNERID) + "\n";

var conn = await $.hdb.getConnection();

query = 'SELECT max("SALESORDERID"+1) as "SALESORDERID" from "SO.Header"';


rs = await conn.executeQuery(query);
console.log("rs "+rs.length);
var overAllId = '';
var length = rs.length;
while(length > 0) {
    overAllId = rs[0].SALESORDERID;
    responseBody += 'so id ' + overAllId + '\n';
    length--;
}
console.log("overAllId"+overAllId); 

//Get the company name for the BP id and store it in a local variable
lv_bp_id = encodeURI(overallsoData.PARTNERID);
//use prepared statement to avoid sql injection attacks
query = 'SELECT COMPANYNAME from "MD.BusinessPartner" where PARTNERID = ?';
rs = await conn.executeQuery(query, lv_bp_id);

if (rs.length > 0) {
    lv_company = rs[0].COMPANYNAME;
    responseBody += 'lv_company ' + lv_company + '\n';
}

so_items = overallsoData.SalesOrderItems;


//Insert all Sales Order Items
if (so_items) {

    for (i; i < so_items.length; i++) {
        responseBody += 'item' + i + ' ' + 'Product_Id:' + so_items[i].Product_Id;
        responseBody += 'item' + i + ' ' + 'Quantity:' + so_items[i].Quantity;

        lv_productid = encodeURI(so_items[i].Product_Id);
        lv_quantity = encodeURI(so_items[i].Quantity);
        // Get price of the product from Product table
        query = 'SELECT PRICE from "MD.Products" where PRODUCTID = ?';
        rs = await conn.executeQuery(query, lv_productid);

        if (rs.length > 0) {
            lv_price = rs[0].PRICE;
            responseBody += 'lv_price ' + lv_price + '\n';
        }

        //create local temporary table to pass as input to the Decision Table Procedure for Tax calculation
        query = "create local temporary table #TT_IN(PARTNERID nvarchar(10),COMPANYNAME nvarchar(80),PRODUCTID nvarchar(10))";
        await conn.executeUpdate(query);

        //Insert values into the local temporary table for bp id,company name and product id for the tax calculation
        try {
            query = "insert into #TT_IN values (?,?,?)";
            await conn.executeUpdate(query, lv_bp_id, lv_company, lv_productid);
        } catch (e) {
            result += e.toString();
        }

        //Call the Procedure for Tax Calculation generated by the Decision Table
        query = 'SELECT * FROM "tax_calculation"() where PARTNERID = ? and  COMPANYNAME= ? and PRODUCTID = ?';
        rs = await conn.executeQuery(query, lv_bp_id, lv_company, lv_productid);
        
        // taxCalculator = conn.loadProcedure('', 'tax_calculation');
        // console.log("tax calculatio"+taxCalculator);   

      //  rs = taxCalculator([{PARTNERID: lv_bp_id, COMPANYNAME: lv_company, PRODUCTID: lv_productid}]);
		 console.log("tax calculatio"+rs.length);   
        //Get the temporary output table name    
        if (rs.length > 0) {
            // lv_table = rs[i].table;
            lv_tax = rs[0].TAX;
            responseBody += 'lv_tax ' + lv_tax + '\n';
        }
console.log("tax"+responseBody);
        lv_netamount = lv_price * lv_quantity;
        //Get the tax amount based on the tax code
        lv_taxamount = lv_netamount * lv_tax;
        lv_grossamount = lv_netamount + lv_taxamount;
        //Insert Item into table
        query = 'insert into "SO.Item"' + " values(?,?,?,'','EUR',?,?,?,'I','',?,'EA','')";
        finalItemId = '';
        if (item_id >= 100) {
            finalItemId =  item_id;
        } else {
            finalItemId =  item_id;
        }
			console.log("item_id"+finalItemId+" overAllId"+overAllId); 
        rs = await conn.executeUpdate(query, ''+overAllId, finalItemId, lv_productid, lv_grossamount,
                                lv_netamount, lv_taxamount, lv_quantity);

        item_id = item_id + 10;

        //Calculate the total of net amount, gross amount and tax amount for all line items
        lv_so_netamount = lv_so_netamount + lv_netamount;
        lv_so_grossamount = lv_so_grossamount + lv_grossamount;
        lv_so_taxamount = lv_so_taxamount + lv_taxamount;
			console.log("item_id"+item_id); 
        //drop the local temporary table
        query = "drop table #TT_IN";
        rs = await conn.executeUpdate(query);

    }

}

//Insert Sales Order Header
query = 'insert into \"SO.Header\"' 
        + " values(?,'0000000033',CURRENT_DATE,'0000000033',CURRENT_DATE,''," 
        + "?,'EUR',?,?,?,'N','I','I')";

rs = await conn.executeUpdate(query, ''+overAllId, overallsoData.PARTNERID,
                        lv_so_grossamount, lv_so_netamount, lv_so_taxamount);

await conn.commit();
await conn.close();

$.response.status = $.net.http.CREATED;
await $.response.setBody(responseBody);
export default {body,overallsoData,responseBody,so_items,gross_amt,prod_price,lv_productid,lv_price,lv_quantity,lv_netamount,lv_taxamount,lv_grossamount,item_id,lv_so_netamount,lv_so_grossamount,lv_so_taxamount,i,lv_bp_id,lv_company,lv_table,lv_tax,result,rs,query,pc,taxCalculator,finalItemId,conn,overAllId,length};
